<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="index.css">
    <title>é©¬èµ›å…‹é¢æ¿</title>
</head>
<body>
    <!-- æ§åˆ¶é¢æ¿ -->
    <div id="controlPanel" class="control-panel">
            <div>
                <label>é•¿</label><input id="length" type="text" onblur="lengthCheck(this.value)" placeholder="è¯·è¾“å…¥æ•´æ•°" />
            </div>
            <div>
                <label>å®½</label><input id="width" type="text" onblur="widthCheck(this.value)" placeholder="è¯·è¾“å…¥æ•´æ•°"/>
            </div>
            <button class="confirm-btn" onclick="onConfirm()">ç¡®å®š</button>
    </div>
    <!-- é©¬èµ›å…‹é¢æ¿ -->
    <div class="mosaic-panel">
        <canvas id="canvas"></canvas>

		<!-- é¢œè‰²å²›æ•°å­— -->
		<div id="numberMask" class="number-mask hide"></div>
	</div>
</body>
<script src="util.js"></script>
<script>
	var canvas = document.querySelector('#canvas');
	var ctx = canvas.getContext('2d');
	var length = width = 0
	var rect={} //å®šä¹‰æ¯ä¸ªå°æ ¼çš„å®½é«˜
	var numberMask = document.getElementById('numberMask')
	var colorIslandsNumber = 1

	// æ§åˆ¶é¢æ¿
    function numberCheck(value) {
        var flag = checkNumber(value);
        if (!flag) {
            alert('è¯·è¾“å…¥æ•´æ•°ï¼');
            return false;
        }
        return true
    }

    function lengthCheck() {
        var value = document.getElementById("length").value;
		length = value
        return numberCheck(value)
    }
    
    function widthCheck() {
        var value = document.getElementById("width").value;
		width = value
        return numberCheck(value)
    }

    function checkForm() {
        var flag = lengthCheck() && widthCheck();
        return flag;
    }

    function onConfirm(){
        if(checkForm()){
			document.getElementById('controlPanel').classList.add('hide');
			initCanvas()
		} 
    }
	
	// é©¬èµ›å…‹ç”»æ¿
	function initCanvas() {
		canvas.width = document.body.clientWidth;
		canvas.height =  document.body.clientHeight;

		//å®šä¹‰æ¯ä¸ªå°æ ¼çš„å®½é«˜
		rect = {
			w: canvas.width / length,
			h: canvas.height / width
		}
		//ç»˜åˆ¶æ¨ªçº¿
		for (var i = 0; i < canvas.height / rect.h; i++) {
			ctx.moveTo(0, i * rect.h);
			ctx.lineTo(canvas.width, i * rect.h);
		}
		//ç»˜åˆ¶ç«–çº¿
		for (var j = 0; j < canvas.width / rect.w; j++) {
			ctx.moveTo(j * rect.w, 0);
			ctx.lineTo(j * rect.w, canvas.height);
		}
		ctx.lineWidth = 0.5;
		ctx.strokeStyle = '#555';
		ctx.stroke();
		
		bindEvents()
	}
	
	function bindEvents() {
		canvas.onmousedown = function (e) {
			console.log("ğŸš€ ~ file: index.html ~ line 110 ~ bindEvents ~ e", e)
			console.log("ğŸš€ ~ file: index.html ~ line 107 ~ bindEvents ~ rect", rect)
			e = window.event || e;
			var eButton = e.button

			if (eButton === 0) { // ç‚¹å‡»å·¦é”®å¡«å……é¢œè‰²
				// console.log("ğŸš€ ~ file: index.html ~ line 109 ~ initCanvas ~ eButton.pageX/rect.w", e.pageX/rect.w)
				var colorStr = getRandomColor()
				var color = `rgb(${colorStr})`

				// ToDo: è®°å½•å½“å‰æ–¹å—è‰²å€¼colorStrå’Œæ–¹å—ä½ç½®åšåŠŸèƒ½ç‚¹7

				var startPos = getRectPosition(e.pageX, e.pageY, rect)
                console.log("ğŸš€ ~ file: index.html ~ line 123 ~ bindEvents ~ startPos", startPos)
				// console.log("ğŸš€ ~ file: index.html ~ line 109 ~ initCanvas ~ startX", startX, startY)
				drawRect(startPos, rect, color)
			} else { // æ¸…é™¤é¢œè‰²
				var startPos = getRectPosition(e.pageX, e.pageY, rect)
				drawRect(startPos, rect, "#ffffff", true)
			}

			// ToDo:  éå†ç”»æ¿æ–¹å—å¹¶è®¡ç®—é¢œè‰²å²›æ•°é‡

			numberMask.innerHTML = colorIslandsNumber
			numberMask.classList.remove('hide');
			setTimeout(function () {
				numberMask.classList.add('hide');
			}, 1300)
		}

		document.oncontextmenu = function (e) {
			var e = e || window.event;
			return false;//å±è”½æµè§ˆå™¨è‡ªå¸¦çš„å³é”®èœå•
		};

		document.onkeydown = function (event) {
			var e = event || window.event || arguments.callee.caller.arguments[0];
			if (e && e.keyCode === 67) { // æŒ‰ C
				console.log('c')

				// ToDo:  å¯¹æ¯ä¸€ä¸ªå·²ç€è‰²çš„æ ¼å­éšæœºäº§ç”Ÿå¦ä¸€ä¸ªé¢œè‰²ï¼Œå¹¶ä¸”è®¾è®¡ä¸€ä¸ªæ¸å˜åŠ¨ç”»ï¼Œæ¯ä¸ªæ ¼å­è¦ä»åŸæ¥çš„é¢œè‰²æ¸å˜æˆæ–°é¢œè‰²
			}
		}

		// ToDo: çª—å£resize åé‡æ–°å®šä¹‰æ–¹æ ¼å¤§å°
	}
</script>
</html>