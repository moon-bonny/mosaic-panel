<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="index.css">
    <title>é©¬èµ›å…‹é¢æ¿</title>
</head>
<body>
    <!-- æ§åˆ¶é¢æ¿ -->
    <div id="controlPanel" class="control-panel">
            <div>
                <label>é•¿</label><input id="length" type="text" onblur="lengthCheck(this.value)" placeholder="è¯·è¾“å…¥æ•´æ•°" />
            </div>
            <div>
                <label>å®½</label><input id="width" type="text" onblur="widthCheck(this.value)" placeholder="è¯·è¾“å…¥æ•´æ•°"/>
            </div>
            <button class="confirm-btn" onclick="onConfirm()">ç¡®å®š</button>
    </div>
    <!-- é©¬èµ›å…‹é¢æ¿ -->
    <div class="mosaic-panel">
        <canvas id="canvas"></canvas>

		<!-- é¢œè‰²å²›æ•°å­— -->
		<div id="numberMask" class="number-mask hide"></div>
	</div>
</body>
<script src="util.js"></script>
<script>
	var canvas = document.querySelector('#canvas');
	var ctx = canvas.getContext('2d');
	var length = width = 0
	var rect={} //å®šä¹‰æ¯ä¸ªå°æ ¼çš„å®½é«˜
	var numberMask = document.getElementById('numberMask')
	var colorIslandsNumber = 1
	var canvasColorInfo = []

	// æ§åˆ¶é¢æ¿
    function numberCheck(value) {
        var flag = checkNumber(value);
        if (!flag) {
            alert('è¯·è¾“å…¥æ•´æ•°ï¼');
            return false;
        }
        return true
    }

    function lengthCheck() {
        var value = document.getElementById("length").value;
		length = value
        return numberCheck(value)
    }
    
    function widthCheck() {
        var value = document.getElementById("width").value;
		width = value
        return numberCheck(value)
    }

    function checkForm() {
        var flag = lengthCheck() && widthCheck();
        return flag;
    }

    function onConfirm(){
        if(checkForm()){
			document.getElementById('controlPanel').classList.add('hide');
			for(var q = 0;q < length;q++){
				canvasColorInfo[q] = []
			}
			initCanvas()
		} 
    }
	
	// é©¬èµ›å…‹ç”»æ¿
	function initCanvas() {
		canvas.width = document.body.clientWidth;
		canvas.height =  document.body.clientHeight;

		//å®šä¹‰æ¯ä¸ªå°æ ¼çš„å®½é«˜
		rect = {
			w: canvas.width / length,
			h: canvas.height / width
		}
		//ç»˜åˆ¶æ¨ªçº¿
		for (var i = 0; i < canvas.height / rect.h; i++) {
			ctx.moveTo(0, i * rect.h);
			ctx.lineTo(canvas.width, i * rect.h);
		}
		//ç»˜åˆ¶ç«–çº¿
		for (var j = 0; j < canvas.width / rect.w; j++) {
			ctx.moveTo(j * rect.w, 0);
			ctx.lineTo(j * rect.w, canvas.height);
		}
		ctx.lineWidth = 0.5;
		ctx.strokeStyle = '#555';
		ctx.stroke();
		
		bindEvents()
	}
	
	function bindEvents() {
		canvas.onmousedown = function (e) {
			if (gradientAnimation) { console.info('æ¸å˜åŠ¨ç”»æ­£åœ¨æ‰§è¡Œï¼Œè¯·å‹¿é¢‘ç¹æ“ä½œ'); return; }

			e = window.event || e;
			var eButton = e.button

			var start = getRectPosition(e.pageX, e.pageY, rect)

			var startPos = start.pos
			var startIndexObj = start.indexObj

			var colorStr = ''
			if (eButton === 0) { // ç‚¹å‡»å·¦é”®å¡«å……é¢œè‰²
				colorStr = getRandomColor()
				var color = `rgb(${colorStr})`
				// è®°å½•å½“å‰æ–¹å—è‰²å€¼colorå’Œæ–¹å—ä½ç½®åšåŠŸèƒ½ç‚¹7
				canvasColorInfo[startIndexObj.i][startIndexObj.j] = {
					pos: start.pos,
					color: colorStr.split(',')
				}
				drawRect(startPos, rect, color)
			} else if(eButton === 2) { // æ¸…é™¤é¢œè‰²
				// var startPos = getRectPosition(e.pageX, e.pageY, rect)
				canvasColorInfo[startIndexObj.i][startIndexObj.j] = null;
				colorStr = '255,255,255'
				drawRect(startPos, rect, `rgb(${colorStr})`, true)
			}

			// ToDo:  éå†ç”»æ¿æ–¹å—å¹¶è®¡ç®—é¢œè‰²å²›æ•°é‡

			numberMask.innerHTML = colorIslandsNumber
			numberMask.classList.remove('hide');
			setTimeout(function () {
				numberMask.classList.add('hide');
			}, 1300)
		}

		document.oncontextmenu = function (e) {
			var e = e || window.event;
			return false;//å±è”½æµè§ˆå™¨è‡ªå¸¦çš„å³é”®èœå•
		};

		var gradientAnimation = false;
		document.onkeydown = function (event) {
			var e = event || window.event || arguments.callee.caller.arguments[0];
			if (e && e.keyCode === 67) { // æŒ‰ C
				if(gradientAnimation) {
					console.info('æ¸å˜åŠ¨ç”»æ­£åœ¨æ‰§è¡Œï¼Œè¯·å‹¿é¢‘ç¹æ“ä½œ');
					return; 
				}

				// å¯¹æ¯ä¸€ä¸ªå·²ç€è‰²çš„æ ¼å­éšæœºäº§ç”Ÿå¦ä¸€ä¸ªé¢œè‰²ï¼Œå¹¶ä¸”è®¾è®¡ä¸€ä¸ªæ¸å˜åŠ¨ç”»ï¼Œæ¯ä¸ªæ ¼å­è¦ä»åŸæ¥çš„é¢œè‰²æ¸å˜æˆæ–°é¢œè‰²
				var animationI = 0;
				var animationJ = 0;
				var animation = async function(){
					gradientAnimation = true
					var temp = canvasColorInfo[animationI][animationJ]
					
					if(temp){
						var newColor = await rectColorGradientAnimation(temp.color, { pos: temp.pos, size: rect })
						temp.color = newColor
					}

					if (animationJ < canvasColorInfo[animationI].length - 1) {
						animationJ++;
						animation()
					}else if(animationI < canvasColorInfo.length - 1){
						animationI++;
						animationJ = 0;
						animation()
					}else {
						gradientAnimation = false
					}
				}
				animation()

				/* canvasColorInfo.forEach(function (item, i) {
					item.forEach(async function(canvasItem, j) {
						console.log(canvasItem)
						if(canvasItem) {
                        console.log("ğŸš€ ~ file: index.html ~ line 192 ~ animation ~ temp.color", temp.color)
                        console.log("ğŸš€ ~ file: index.html ~ line 192 ~ animation ~ temp.color", temp.color)
							var newColor = await rectColorGradientAnimation(canvasItem.color, {pos: canvasItem.pos, size: rect})
							canvasColorInfo[i][j].color = newColor
							
						}
					})
				}); */
			}
		}

		// ToDo: çª—å£resize åé‡æ–°å®šä¹‰æ–¹æ ¼å¤§å°
	}
</script>
</html>